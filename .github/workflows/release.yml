name: Build and Release S3Mate

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

env:
  APP_NAME: S3Mate

# === Release for LINUX ===
jobs:
  release-linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: 8.7

      - name: Build fat JAR
        run: gradle clean fatJar -Pversion=${{ steps.version.outputs.version }}

      - name: Build Linux jpackage
        run: |
          gradle jpackageLin -Pversion=${{ steps.version.outputs.version }}
          tar -czf build/s3mate-${{ steps.version.outputs.version }}-linux.tar.gz \
            -C build/jpackage/linux S3Mate

      - name: Generate checksums
        run: |
          sha256sum build/libs/s3mate-${{ steps.version.outputs.version }}-all.jar > build/checksums-linux.txt
          sha256sum build/s3mate-${{ steps.version.outputs.version }}-linux.tar.gz >> build/checksums-linux.txt

      - name: Delete existing Linux assets
        uses: mknejp/delete-release-assets@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: v${{ steps.version.outputs.version }}
          fail-if-no-release: false
          fail-if-no-assets: false
          assets: |
            s3mate-*linux*
            checksums-linux.txt

      - name: Upload Linux artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          files: |
            build/libs/s3mate-${{ steps.version.outputs.version }}-all.jar
            build/s3mate-${{ steps.version.outputs.version }}-linux.tar.gz
            build/checksums-linux.txt
          fail_on_unmatched_files: true

  # === Release for MacOS ===
  release-mac:
    runs-on: macos-latest
    needs: release-linux

    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: 8.7

      - name: Build macOS jpackage (unsigned)
        run: |
          gradle clean jpackageMac -Pversion=${{ steps.version.outputs.version }}
          tar -czf build/s3mate-${{ steps.version.outputs.version }}-mac.tar.gz \
            -C build/jpackage/mac S3Mate.app

      - name: Generate checksums
        run: |
          shasum -a 256 build/s3mate-${{ steps.version.outputs.version }}-mac.tar.gz \
            > build/checksums-mac.txt

      - name: Delete existing macOS assets
        uses: mknejp/delete-release-assets@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: v${{ steps.version.outputs.version }}
          fail-if-no-release: false
          fail-if-no-assets: false
          assets: |
            s3mate-*mac*
            checksums-mac.txt

      - name: Upload macOS artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          files: |
            build/s3mate-${{ steps.version.outputs.version }}-mac.tar.gz
            build/checksums-mac.txt
          fail_on_unmatched_files: true

  # === Release for Windows ===
  release-win:
    runs-on: windows-latest
    needs: release-linux

    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        shell: bash
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: 8.7

      - name: Install WiX Toolset
        run: choco install wixtoolset -y

      - name: Build Windows EXE
        shell: pwsh
        run: |
          gradle clean jpackageWin "-Pversion=${{ steps.version.outputs.version }}"
          
          Compress-Archive `
            build\jpackage\win\*.exe `
            build\s3mate-${{ steps.version.outputs.version }}-win.zip

      - name: Generate checksums
        shell: pwsh
        run: |
          Get-FileHash build\s3mate-${{ steps.version.outputs.version }}-win.zip -Algorithm SHA256 |
            ForEach-Object { "$($_.Hash)  s3mate-${{ steps.version.outputs.version }}-win.zip" } |
            Out-File build\checksums-win.txt -Encoding ascii

      - name: Delete existing Windows assets
        uses: mknejp/delete-release-assets@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: v${{ steps.version.outputs.version }}
          fail-if-no-release: false
          fail-if-no-assets: false
          assets: |
            s3mate-*win*
            checksums-win.txt

      - name: Upload Windows artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          files: |
            build/s3mate-${{ steps.version.outputs.version }}-win.zip
            build/checksums-win.txt
          fail_on_unmatched_files: true
