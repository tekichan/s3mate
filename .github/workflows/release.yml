name: Build and Release S3Mate

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

env:
  APP_NAME: S3Mate

jobs:
  # ======================= LINUX =======================
  release-linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: 8.7

      - name: Build fat JAR
        run: gradle clean fatJar -Pversion=${{ steps.version.outputs.version }}

      - name: Build Linux jpackage
        run: |
          gradle jpackageLin -Pversion=${{ steps.version.outputs.version }}
          tar -czf build/s3mate-${{ steps.version.outputs.version }}-linux.tar.gz \
            -C build/jpackage/linux S3Mate

      - name: Generate checksums
        run: |
          sha256sum build/libs/s3mate-${{ steps.version.outputs.version }}-all.jar > build/checksums-linux.txt
          sha256sum build/s3mate-${{ steps.version.outputs.version }}-linux.tar.gz >> build/checksums-linux.txt

      - name: Upload Linux artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          files: |
            build/libs/s3mate-${{ steps.version.outputs.version }}-all.jar
            build/s3mate-${{ steps.version.outputs.version }}-linux.tar.gz
            build/checksums-linux.txt
  

  # ======================= MAC =======================
  release-mac:
    runs-on: macos-latest
    needs: release-linux

    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: 8.7

      # ---- Import Apple certificate ----
      - name: Import macOS signing certificate
        run: |
          echo "$MAC_CERT_P12" | base64 --decode > cert.p12
          security create-keychain -p "" build.keychain
          security import cert.p12 -k build.keychain -P "$MAC_CERT_PASSWORD" -T /usr/bin/codesign
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
        env:
          MAC_CERT_P12: ${{ secrets.MAC_CERT_P12 }}
          MAC_CERT_PASSWORD: ${{ secrets.MAC_CERT_PASSWORD }}

      - name: Build macOS jpackage
        run: |
          gradle clean jpackageMac -Pversion=${{ steps.version.outputs.version }}
          codesign --deep --force --options runtime \
            --sign "${{ secrets.MAC_SIGN_IDENTITY }}" \
            build/jpackage/mac/S3Mate.app

          tar -czf build/s3mate-${{ steps.version.outputs.version }}-mac.tar.gz \
            -C build/jpackage/mac S3Mate.app

      - name: Generate checksums
        run: |
          shasum -a 256 build/s3mate-${{ steps.version.outputs.version }}-mac.tar.gz \
            > build/checksums-mac.txt

      - name: Upload macOS artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          files: |
            build/s3mate-${{ steps.version.outputs.version }}-mac.tar.gz
            build/checksums-mac.txt
  

  # ======================= WINDOWS =======================
  release-win:
    runs-on: windows-latest
    needs: release-linux

    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        shell: bash
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: 8.7

      - name: Build Windows EXE
        run: |
          gradle clean jpackageWin -Pversion=${{ steps.version.outputs.version }}
          Compress-Archive `
            build\jpackage\win\S3Mate `
            build\s3mate-${{ steps.version.outputs.version }}-win.zip

      - name: Generate checksums
        run: |
          certutil -hashfile build\s3mate-${{ steps.version.outputs.version }}-win.zip SHA256 `
            > build\checksums-win.txt

      - name: Upload Windows artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          files: |
            build/s3mate-${{ steps.version.outputs.version }}-win.zip
            build/checksums-win.txt
